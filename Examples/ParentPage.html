<!-- Imagine this is a wrapper inside of ASSISTments -->
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
        <script type="text/javascript" src="js/Util/emacs5-compatibility-patches.js"></script>
        <script type="text/javascript" src="js/Util/uuid.js"></script>
		<script type="text/javascript" src="js/Util/zet.js"></script>
		<script type="text/javascript" src="js/Util/serialization.js"></script>
		<script type="text/javascript" src="js/Core/messaging.js"></script>
		<script type="text/javascript" src="js/Core/messaging-gateway.js"></script>
		<script type="text/javascript" src="js/Services/Orchestration/heartbeat-service.js"></script>
        
		<script type="text/javascript">
            var GATEWAY,
                CHILD_WINDOW,
                CHILD_GATEWAY,
                TEST_SERVICE,
                HEART_MONITOR_SERVICE,
                ON_SKIP_HEARTBEAT,
                HEARTBEAT_NAME = "ChildHeatbeat",
                COMPLETED_VERB = 'Completed';
            
            ON_SKIP_HEARTBEAT = function(name, monitor){
                alert("Heartbear skipped a beat: " + name);
                monitor.stop();
            }
            
            window.onload = function(){
                CHILD_WINDOW = document.getElementById("Child").contentWindow;
                CHILD_GATEWAY = Messaging_Gateway.PostMessageGatewayStub("Child Gateway Stub", null, null, CHILD_WINDOW);
                TEST_SERVICE = Messaging_Gateway.TestService("ParentTestService");
                HEART_MONITOR_SERVICE = Heartbeat_Service.HeartbeatMonitor(null, [HEARTBEAT_NAME],
                    null, ON_SKIP_HEARTBEAT);
			
                MAIN_POSTING_GATEWAY = Messaging_Gateway.PostMessageGateway("MainPostingGateway", 
                    [CHILD_GATEWAY, HEART_MONITOR_SERVICE, TEST_SERVICE]);
                
                // A service that is looking for a certain message
                // In this case, looking for "Completed" as a verb and "Inform" as the speech act (i.e., Informing that x is completed)
                // Technically, better to subclass using Zet (examples found in messaging-gateway.js), 
                // but this works fine too as long as you're not trying to handle anything crazy.
                var oldReceiveMsg = TEST_SERVICE.receiveMessage;
                TEST_SERVICE.receiveMessage = function(msg){
                    oldReceiveMsg(msg);
                    if ((msg.getSpeechAct() == Messaging.INFORM_ACT) &&
                        (msg.getVerb() == COMPLETED_VERB)){
                        document.getElementById("AnElement").innerHTML  = "The activity is complete!<br><br>" + 
                            "This message was sent to " + msg.getSpeechAct() + " that: <br>" +
                            "The Learner '" + msg.getActor() + "' " + msg.getVerb() + " <br>" +
                            "the activity '" + msg.getObject() + "'<br>" + 
                            "with the score " + msg.getResult();
                    }
                };
                
                // Mark that everything is loaded
                document.getElementById('AnElement').innerHTML = 'You are working on some activity now.';
            };
		</script>
	</head>
	<body>
        <iframe id="Child" src="ChildWindow.html?learnerId=SmartyPants&referrerId=ASSISTmentsGUID"></iframe>
        <div id="AnElement">The page is loading.</div>
	</body>
</html>

